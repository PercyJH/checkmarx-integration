name: Checkmarx Security Analysis
description: Ejecuta análisis SAST + SCA con Checkmarx One

inputs:
  project-name:
    description: Nombre del proyecto en Checkmarx One
    required: true

  branch:
    description: Branch a escanear
    required: false
    default: ${{ github.ref_name }}

  fail-on-severity:
    description: Severidad para fallar pipeline (low|medium|high|critical)
    required: false
    default: high

  use-vault:
    description: Obtener credenciales desde HashiCorp Vault
    required: false
    default: "false"

runs:
  using: composite
  steps:

    - name: Checkout repository
      uses: actions/checkout@v4

    # ===================================================== DE VAULT
    - name: Retrieve credentials from Vault
      if: inputs.use-vault == 'true'
      shell: bash
      run: |
        echo "Retrieving Checkmarx credentials from Vault..."
        # CHECKMARX_CLIENT_ID
        # CHECKMARX_CLIENT_SECRET
        # CHECKMARX_TENANT
        # CHECKMARX_BASE_URI

    # ===================================================== AUTENTICACIÓN
    - name: Authenticate to Checkmarx One
      uses: checkmarx/ast-github-action@v2
      with:
        base_uri: ${{ env.CHECKMARX_BASE_URI || secrets.CHECKMARX_BASE_URI }}
        tenant: ${{ env.CHECKMARX_TENANT || secrets.CHECKMARX_TENANT }}
        client_id: ${{ env.CHECKMARX_CLIENT_ID || secrets.CHECKMARX_CLIENT_ID }}
        client_secret: ${{ env.CHECKMARX_CLIENT_SECRET || secrets.CHECKMARX_CLIENT_SECRET }}
        authentication_type: client_secret
        persist_credentials: true

    # ===================================================== SCAN SAST + SCA
    - name: Run Checkmarx SAST + SCA
      uses: checkmarx/ast-github-action@v2
      with:
        project_name: ${{ inputs.project-name }}
        branch: ${{ inputs.branch }}
        sast: true
        sca: true
        incremental: true
        fail_on: ${{ inputs.fail-on-severity }}

    # ===================================================== SUMMARY
    - name: Summary
      shell: bash
      run: |
        echo "## Checkmarx Security Analysis (SAST + SCA)" >> $GITHUB_STEP_SUMMARY
        echo "- Project: ${{ inputs.project-name }}" >> $GITHUB_STEP_SUMMARY
        echo "- Branch:  ${{ inputs.branch }}" >> $GITHUB_STEP_SUMMARY
        echo "- Vulnerability summary is provided natively by Checkmarx One." >> $GITHUB_STEP_SUMMARY
