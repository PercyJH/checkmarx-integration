name: Checkmarx SCA Analysis
description: Reusable action for Checkmarx One SCA scan

inputs:
  project-name:
    description: Project name in Checkmarx One
    required: true
  branch:
    description: Branch name
    required: false
    default: ${{ github.ref_name }}
  fail-on-severity:
    description: Fail build on vulnerabilities of this severity or higher (low|medium|high|critical)
    required: false
    default: high

runs:
  using: composite
  steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    # ðŸ‘‰ AutenticaciÃ³n (placeholder enterprise)
    - name: Authenticate to Checkmarx One
      uses: checkmarx/ast-github-action@v2
      with:
        base_uri: ${{ env.CHECKMARX_BASE_URI }}
        tenant: ${{ env.CHECKMARX_TENANT }}
        client_id: ${{ env.CHECKMARX_CLIENT_ID }}
        client_secret: ${{ env.CHECKMARX_CLIENT_SECRET }}
        authentication_type: client_secret
        persist_credentials: true

    # ðŸ‘‰ SCA Scan
    - name: Run Checkmarx SCA scan
      uses: checkmarx/ast-github-action@v2
      with:
        project_name: ${{ inputs.project-name }}
        branch: ${{ inputs.branch }}
        sca: true
        fail_on: ${{ inputs.fail-on-severity }}

    # ðŸ‘‰ Nota importante para gerencia / vendor
    - name: Scan summary
      shell: bash
      run: |
        echo "## Checkmarx SCA Analysis" >> $GITHUB_STEP_SUMMARY
        echo "- Project: ${{ inputs.project-name }}" >> $GITHUB_STEP_SUMMARY
        echo "- Branch:  ${{ inputs.branch }}" >> $GITHUB_STEP_SUMMARY
        echo "- Results and vulnerability summary are provided natively by Checkmarx One." >> $GITHUB_STEP_SUMMARY
